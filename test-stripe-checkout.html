<!DOCTYPE html>
<html>
<head>
    <title>Test Stripe Checkout Function</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px 0; }
        pre { background: #000; padding: 20px; border-radius: 5px; overflow: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        input, select { padding: 8px; margin: 5px 0; display: block; width: 300px; }
    </style>
</head>
<body>
    <h1>üß™ Test Stripe Checkout Function</h1>

    <div>
        <label>Email:</label>
        <input type="email" id="email" value="test@example.com" />

        <label>User ID (fake):</label>
        <input type="text" id="userId" value="test-user-123" />

        <label>Plan:</label>
        <select id="plan">
            <option value="monthly">Mensuel (price_1StWgr6OhZ2TN4iPIwcnJEqp)</option>
            <option value="yearly" selected>Annuel (price_1StWu76OhZ2TN4iPchmtTRty)</option>
        </select>

        <button onclick="testFunction()">üöÄ Tester la fonction Stripe Checkout</button>
    </div>

    <h2>R√©sultat:</h2>
    <pre id="result">Clique sur le bouton pour tester...</pre>

    <script>
        const SUPABASE_URL = 'https://vbaaohcsmiaxbqcyfhhl.supabase.co';
        const PRICE_IDS = {
            monthly: 'price_1StWgr6OhZ2TN4iPIwcnJEqp',
            yearly: 'price_1StWu76OhZ2TN4iPchmtTRty'
        };

        async function testFunction() {
            const result = document.getElementById('result');
            const email = document.getElementById('email').value;
            const userId = document.getElementById('userId').value;
            const plan = document.getElementById('plan').value;
            const priceId = PRICE_IDS[plan];

            result.innerHTML = '‚è≥ Test en cours...\n\n';
            result.innerHTML += `üìß Email: ${email}\n`;
            result.innerHTML += `üë§ User ID: ${userId}\n`;
            result.innerHTML += `üí≥ Plan: ${plan}\n`;
            result.innerHTML += `üé´ Price ID: ${priceId}\n\n`;
            result.innerHTML += `üì° URL: ${SUPABASE_URL}/functions/v1/stripe-checkout\n\n`;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/stripe-checkout`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            priceId: priceId,
                            userId: userId,
                            email: email
                        })
                    }
                );

                result.innerHTML += `üìä Status: ${response.status} ${response.statusText}\n\n`;

                const data = await response.json();

                if (response.ok) {
                    result.className = 'success';
                    result.innerHTML += '‚úÖ SUCC√àS!\n\n';
                    result.innerHTML += JSON.stringify(data, null, 2);

                    if (data.url) {
                        result.innerHTML += '\n\nüîó URL Stripe: ' + data.url;
                        result.innerHTML += '\n\nüëâ La fonction fonctionne correctement!';
                    }
                } else {
                    result.className = 'error';
                    result.innerHTML += '‚ùå ERREUR!\n\n';
                    result.innerHTML += JSON.stringify(data, null, 2);

                    // Diagnostics
                    result.innerHTML += '\n\nüîç DIAGNOSTICS:\n';
                    if (data.error && data.error.includes('STRIPE_SECRET_KEY')) {
                        result.innerHTML += '‚ö†Ô∏è La cl√© secr√®te Stripe n\'est pas configur√©e dans Supabase\n';
                        result.innerHTML += '‚û°Ô∏è Va sur Supabase > Settings > Edge Functions > Secrets\n';
                        result.innerHTML += '‚û°Ô∏è Ajoute STRIPE_SECRET_KEY avec ta cl√© sk_test_...\n';
                    }
                    if (response.status === 404) {
                        result.innerHTML += '‚ö†Ô∏è La fonction stripe-checkout n\'existe pas ou n\'est pas d√©ploy√©e\n';
                        result.innerHTML += '‚û°Ô∏è Lance: ./DEPLOY.sh\n';
                    }
                }
            } catch (error) {
                result.className = 'error';
                result.innerHTML += '‚ùå ERREUR R√âSEAU!\n\n';
                result.innerHTML += error.toString();
                result.innerHTML += '\n\nüîç Possible causes:\n';
                result.innerHTML += '- La fonction n\'est pas d√©ploy√©e\n';
                result.innerHTML += '- Probl√®me de CORS\n';
                result.innerHTML += '- URL Supabase incorrecte\n';
            }
        }
    </script>
</body>
</html>
